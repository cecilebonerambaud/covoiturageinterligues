<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Covoiturage</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">

<div class="max-w-4xl mx-auto">
  <h1 class="text-3xl font-bold text-center mb-2">ðŸš— Organisation du covoiturage</h1>
  <p class="text-center text-gray-600 mb-4">Interligues U16 - 2026 - Saint BRIEUC</p>

  <div class="flex justify-center gap-3 mb-6">
    <button id="saveBtn" class="bg-green-600 text-white px-6 py-2 rounded-xl shadow hover:bg-green-700">
      ðŸ’¾ Enregistrer sur Drive
    </button>
    <button id="loadBtn" class="bg-blue-600 text-white px-6 py-2 rounded-xl shadow hover:bg-blue-700">
      ðŸ”„ Charger
    </button>
  </div>

  <!-- RÃ©sumÃ© -->
  <div id="summary" class="bg-white rounded-2xl shadow-lg p-4 mb-6"></div>

  <div id="events" class="space-y-6"></div>
</div>

<template id="event-template">
  <div class="bg-white rounded-2xl shadow-lg p-5">
    <h2 class="text-lg font-semibold mb-4"></h2>

    <div class="flex flex-col sm:flex-row gap-2 mb-4">
      <input type="text" placeholder="Conducteur" class="driver border rounded p-2 flex-1" />
      <input type="number" placeholder="Places" min="1" class="seats border rounded p-2 w-full sm:w-32" />
      <button class="add-car bg-indigo-600 text-white px-4 py-2 rounded-xl">+ Voiture</button>
    </div>

    <div class="cars space-y-3"></div>
  </div>
</template>

<template id="car-template">
  <div class="bg-gray-50 border rounded-xl p-4">
    <div class="flex justify-between items-center mb-3">
      <div class="font-semibold">
        ðŸš˜ <span class="driver-name"></span>
        <span class="text-sm text-gray-500">â€” <span class="remaining"></span> places restantes</span>
      </div>
    </div>

    <div class="flex flex-col sm:flex-row gap-2 mb-2">
      <input type="text" placeholder="Nom" class="passenger-name border rounded p-2 flex-1" />
      <input type="tel" placeholder="TÃ©lÃ©phone" class="passenger-phone border rounded p-2 flex-1" />
      <button class="add-passenger bg-green-600 text-white px-3 py-2 rounded-xl">Ajouter</button>
    </div>

    <ul class="passenger-list space-y-1"></ul>
  </div>
</template>

<script>
/* ================= CONFIG GOOGLE DRIVE =================
   ðŸ‘‰ Tu mettras ici l'URL du Web App Google Apps Script
*/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwz1DXfobNGYexlzas1jldVPHcYjGhWz0Iyofy9o5Dp5W-uS490HR0nmJIzPA-3tn_ALA/exec";

const eventsData = [
  "1er mars â€” Aller - Saran 10h",
  "1er mars â€” Retour - Saran 15h30",
  "14 mars â€” Aller - Olivet 9h",
  "15 mars â€” Retour - Olivet ?"
];

let state = {};

const eventsContainer = document.getElementById("events");
const summaryContainer = document.getElementById("summary");
const eventTemplate = document.getElementById("event-template");
const carTemplate = document.getElementById("car-template");

/* ================= SAVE TO DRIVE ================= */
document.getElementById("saveBtn").onclick = async () => {
  if (!SCRIPT_URL.includes("http")) {
    alert("Ajoute ton URL Apps Script d'abord");
    return;
  }

  await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify(state)
  });

  alert("âœ… DonnÃ©es enregistrÃ©es dans ton Google Drive");
};

/* ================= LOAD FROM DRIVE ================= */
document.getElementById("loadBtn").onclick = async () => {
  const res = await fetch(SCRIPT_URL);
  const data = await res.json();
  if (data) state = data;
  render();
};

/* ================= SUMMARY ================= */
function renderSummary() {
  summaryContainer.innerHTML = "<h2 class='font-semibold mb-2'>ðŸ“Š RÃ©sumÃ© des places restantes</h2>";

  eventsData.forEach((title, index) => {
    const cars = state[index] || [];

    let totalSeats = 0;
    let taken = 0;

    cars.forEach(car => {
      totalSeats += car.seats;
      taken += car.passengers.length;
    });

    const remaining = totalSeats - taken;

    const div = document.createElement("div");
    div.className = "flex justify-between border-b py-1 text-sm";
    div.innerHTML = `<span>${title}</span><span>${remaining} place(s) restante(s)</span>`;

    summaryContainer.appendChild(div);
  });
}

/* ================= EVENTS ================= */
function createEvent(title, index) {
  if (!state[index]) state[index] = [];

  const clone = eventTemplate.content.cloneNode(true);
  clone.querySelector("h2").textContent = title;

  const addCarBtn = clone.querySelector(".add-car");
  const carsContainer = clone.querySelector(".cars");
  const driverInput = clone.querySelector(".driver");
  const seatsInput = clone.querySelector(".seats");

  addCarBtn.onclick = () => {
    const driver = driverInput.value.trim();
    const seats = parseInt(seatsInput.value);
    if (!driver || !seats) return alert("Infos invalides");

    state[index].push({ driver, seats, passengers: [] });
    render();
  };

  state[index].forEach((car, carIndex) => {
    carsContainer.appendChild(createCar(index, carIndex, car));
  });

  return clone;
}

/* ================= CARS ================= */
function createCar(eventIndex, carIndex, car) {
  const clone = carTemplate.content.cloneNode(true);

  const driverName = clone.querySelector(".driver-name");
  const remainingSpan = clone.querySelector(".remaining");
  const nameInput = clone.querySelector(".passenger-name");
  const phoneInput = clone.querySelector(".passenger-phone");
  const addBtn = clone.querySelector(".add-passenger");
  const list = clone.querySelector(".passenger-list");

  driverName.textContent = car.driver;

  const remaining = () => car.seats - car.passengers.length;
  remainingSpan.textContent = remaining();

  addBtn.onclick = () => {
    const name = nameInput.value.trim();
    const phone = phoneInput.value.trim();
    if (!name) return;
    if (remaining() <= 0) return alert("Voiture complÃ¨te");

    car.passengers.push({ name, phone });
    render();
  };

  car.passengers.forEach((p, passengerIndex) => {
    const li = document.createElement("li");
    li.className = "bg-white border rounded-lg p-2 flex justify-between items-center";

    const info = document.createElement("span");
    info.textContent = `${p.name} (${p.phone || "pas de tel"})`;

    const actions = document.createElement("div");
    actions.className = "flex gap-2";

    const editBtn = document.createElement("button");
    editBtn.textContent = "âœï¸";
    editBtn.onclick = () => {
      const newName = prompt("Modifier le nom", p.name);
      if (newName === null) return;
      const newPhone = prompt("Modifier tÃ©lÃ©phone", p.phone);
      car.passengers[passengerIndex] = { name: newName, phone: newPhone };
      render();
    };

    const delBtn = document.createElement("button");
    delBtn.textContent = "ðŸ—‘";
    delBtn.onclick = () => {
      car.passengers.splice(passengerIndex, 1);
      render();
    };

    actions.appendChild(editBtn);
    actions.appendChild(delBtn);

    li.appendChild(info);
    li.appendChild(actions);
    list.appendChild(li);
  });

  return clone;
}

/* ================= RENDER ================= */
function render() {
  eventsContainer.innerHTML = "";
  eventsData.forEach((title, index) => {
    eventsContainer.appendChild(createEvent(title, index));
  });
  renderSummary();
}

render();
</script>
</body>
</html>
