<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Covoiturage Interligues</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">

<div class="max-w-4xl mx-auto">
  <h1 class="text-3xl font-bold text-center mb-2">ðŸš— Organisation du covoiturage</h1>
  <p class="text-center text-gray-600 mb-6">Interligues U16 â€” Saintâ€‘Brieuc</p>

  <!-- RÃ©sumÃ© global -->
  <div id="summary" class="bg-white rounded-2xl shadow-lg p-4 mb-6"></div>

  <!-- Conteneur trajets -->
  <div id="events" class="space-y-8"></div>
</div>

<script>
/* ======================================================
   CONFIG
====================================================== */

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwz1DXfobNGYexlzas1jldVPHcYjGhWz0Iyofy9o5Dp5W-uS490HR0nmJIzPA-3tn_ALA/exec";

const EVENTS = [
  "14 mars â€” Aller - Olivet 9h",
  "15 mars â€” Retour - Olivet"
];

let rawData = [];
let lastHash = "";

const eventsContainer = document.getElementById("events");
const summaryContainer = document.getElementById("summary");

/* ======================================================
   SYNCHRONISATION AUTOMATIQUE GOOGLE DRIVE
====================================================== */

async function sync() {
  try {
    const res = await fetch(SCRIPT_URL);
    const data = await res.json();

    const hash = JSON.stringify(data);
    if (hash === lastHash) return; // rien changÃ©

    lastHash = hash;
    rawData = data;
    render();

  } catch (e) {
    console.error("Erreur sync", e);
  }
}

setInterval(sync, 3000);
sync();

/* ======================================================
   TRANSFORM DATA â†’ STRUCTURE UTILISABLE
====================================================== */

function buildState() {
  const map = {};
  EVENTS.forEach(e => map[e] = {});

  rawData.slice(1).forEach((row, i) => {
    const [trajet, voiture, conducteur, places, passager, tel] = row;

    if (!map[trajet]) return;

    if (!map[trajet][voiture]) {
      map[trajet][voiture] = {
        conducteur,
        places: Number(places),
        passagers: []
      };
    }

    if (passager) {
      map[trajet][voiture].passagers.push({
        nom: passager,
        tel,
        row: i + 2
      });
    }
  });

  return map;
}

/* ======================================================
   RENDER GLOBAL
====================================================== */

function render() {
  const state = buildState();

  eventsContainer.innerHTML = "";

  let totalSeats = 0;
  let totalTaken = 0;

  EVENTS.forEach(trajet => {

    const cars = state[trajet];

    const section = document.createElement("div");
    section.className = "bg-white rounded-2xl shadow-lg p-5";

    section.innerHTML = `
      <h2 class="text-xl font-semibold mb-4">${trajet}</h2>

      <div class="flex flex-col sm:flex-row gap-2 mb-4">
        <input placeholder="Conducteur" id="driver-${trajet}" class="border rounded p-2 flex-1" />
        <input placeholder="Nom voiture" id="car-${trajet}" class="border rounded p-2 flex-1" />
        <input type="number" placeholder="Places" id="seats-${trajet}" class="border rounded p-2 w-full sm:w-32" />
        <button onclick="addCar('${trajet}')" class="bg-indigo-600 text-white px-4 py-2 rounded-xl">+ Voiture</button>
      </div>

      <div class="cars space-y-4"></div>
    `;

    const carsContainer = section.querySelector(".cars");

    Object.entries(cars).forEach(([carName, car]) => {

      const remaining = car.places - car.passagers.length;
      totalSeats += car.places;
      totalTaken += car.passagers.length;

      const carDiv = document.createElement("div");
      carDiv.className = "bg-gray-50 border rounded-xl p-4";

      carDiv.innerHTML = `
        <div class="font-semibold mb-2">ðŸš˜ ${carName} â€” ${car.conducteur}</div>
        <div class="text-sm mb-2">Places restantes : <b>${remaining}</b></div>
        <div class="passengers space-y-1"></div>

        <input placeholder="Nom" id="name-${trajet}-${carName}" class="border rounded p-2 w-full mt-2" />
        <input placeholder="TÃ©lÃ©phone" id="phone-${trajet}-${carName}" class="border rounded p-2 w-full mt-2" />
        <button onclick="addPassenger('${trajet}','${carName}','${car.conducteur}',${car.places},${remaining})"
          class="bg-green-600 text-white w-full py-2 mt-2 rounded-xl">
          Prendre une place
        </button>
      `;

      const list = carDiv.querySelector(".passengers");

      car.passagers.forEach(p => {
        const row = document.createElement("div");
        row.className = "flex justify-between text-sm border-b py-1";
        row.innerHTML = `
          <span>ðŸ‘¤ ${p.nom} (${p.tel || ""})</span>
          <button onclick="removePassenger(${p.row})">ðŸ—‘</button>
        `;
        list.appendChild(row);
      });

      carsContainer.appendChild(carDiv);
    });

    eventsContainer.appendChild(section);
  });

  const remainingTotal = totalSeats - totalTaken;

  summaryContainer.innerHTML = `
    <h2 class="font-semibold mb-2">ðŸ“Š RÃ©sumÃ© global</h2>
    <div>${remainingTotal} place(s) restante(s) au total</div>
  `;
}

/* ======================================================
   ACTIONS GOOGLE DRIVE
====================================================== */

async function addCar(trajet) {
  await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      trajet,
      voiture: document.getElementById(`car-${trajet}`).value,
      conducteur: document.getElementById(`driver-${trajet}`).value,
      places_total: document.getElementById(`seats-${trajet}`).value,
      passager: "",
      telephone: ""
    })
  });
}

async function addPassenger(trajet, voiture, conducteur, places, remaining) {
  if (remaining <= 0) return alert("Voiture complÃ¨te");

  const name = document.getElementById(`name-${trajet}-${voiture}`).value;
  const phone = document.getElementById(`phone-${trajet}-${voiture}`).value;

  if (!name) return alert("Nom requis");

  await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      trajet,
      voiture,
      conducteur,
      places_total: places,
      passager: name,
      telephone: phone
    })
  });
}

async function removePassenger(row) {
  if (!confirm("Supprimer ce passager ?")) return;

  await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({ action: "delete", row })
  });
}

</script>
</body>
</html>
