<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Covoiturage</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-100 p-4">

<div class="max-w-4xl mx-auto">

<h1 class="text-2xl font-bold text-center mb-6">
ðŸš— Covoiturage Interligues
</h1>

<div id="app"></div>

</div>

<script>

const API = "COLLE_ICI_TON_URL_APPS_SCRIPT";

/* ===== TRAJETS ===== */

const TRAJETS = [
"14 mars â€” Aller - Olivet 9h",
"15 mars â€” Retour - Olivet"
];

let sheetData = [];
let lastHash = "";

/* ===== SYNC AUTO ===== */

async function sync() {

  const res = await fetch(API);
  const data = await res.json();

  const hash = JSON.stringify(data);
  if (hash === lastHash) return;

  lastHash = hash;
  sheetData = data;

  render();
}

setInterval(sync,3000);
sync();

/* ===== STRUCTURE ===== */

function build() {

  const map = {};
  TRAJETS.forEach(t=>map[t]={});

  sheetData.slice(1).forEach((r,i)=>{

    const [trajet,voiture,conducteur,places,passager,tel]=r;

    if(!map[trajet]) return;

    if(!map[trajet][voiture]){
      map[trajet][voiture]={
        conducteur,
        places:Number(places),
        passagers:[]
      };
    }

    if(passager){
      map[trajet][voiture].passagers.push({
        nom:passager,
        tel,
        row:i+2
      });
    }

  });

  return map;
}

/* ===== RENDER ===== */

function render(){

  const state = build();
  const app=document.getElementById("app");
  app.innerHTML="";

  TRAJETS.forEach(trajet=>{

    const block=document.createElement("div");
    block.className="bg-white p-4 rounded-xl shadow mb-6";

    block.innerHTML=`
      <h2 class="font-semibold mb-3">${trajet}</h2>

      <input id="driver-${trajet}" placeholder="Conducteur" class="border p-2 w-full mb-2 rounded">
      <input id="car-${trajet}" placeholder="Nom voiture" class="border p-2 w-full mb-2 rounded">
      <input id="seats-${trajet}" type="number" placeholder="Places" class="border p-2 w-full mb-3 rounded">

      <button onclick="addCar('${trajet}')" 
      class="bg-indigo-600 text-white w-full py-2 rounded mb-4">
      + Ajouter voiture
      </button>

      <div id="cars-${trajet}"></div>
    `;

    const carsDiv=block.querySelector(`#cars-${trajet}`);

    Object.entries(state[trajet]).forEach(([name,car])=>{

      const rest=car.places-car.passagers.length;

      const div=document.createElement("div");
      div.className="border rounded p-3 mb-3";

      div.innerHTML=`
        <b>ðŸš˜ ${name}</b> â€” ${car.conducteur}<br>
        Places restantes : ${rest}

        <div class="my-2">
          ${car.passagers.map(p=>`
            <div class="flex justify-between text-sm">
              ${p.nom} (${p.tel||""})
              <button onclick="remove(${p.row})">ðŸ—‘</button>
            </div>
          `).join("")}
        </div>

        <input id="name-${trajet}-${name}" placeholder="Votre nom" class="border p-2 w-full mb-2 rounded">
        <input id="tel-${trajet}-${name}" placeholder="TÃ©lÃ©phone" class="border p-2 w-full mb-2 rounded">

        <button onclick="takeSeat('${trajet}','${name}','${car.conducteur}',${car.places},${rest})"
        class="bg-green-600 text-white w-full py-2 rounded">
        Prendre une place
        </button>
      `;

      carsDiv.appendChild(div);
    });

    app.appendChild(block);
  });
}

/* ===== ACTIONS ===== */

async function addCar(trajet){

await fetch(API,{
method:"POST",
body:JSON.stringify({
trajet,
voiture:document.getElementById(`car-${trajet}`).value,
conducteur:document.getElementById(`driver-${trajet}`).value,
places:document.getElementById(`seats-${trajet}`).value,
passager:"",
telephone:""
})
});
}

async function takeSeat(trajet,voiture,conducteur,places,rest){

if(rest<=0) return alert("Voiture complÃ¨te");

const nom=document.getElementById(`name-${trajet}-${voiture}`).value;
const tel=document.getElementById(`tel-${trajet}-${voiture}`).value;

if(!nom) return alert("Nom requis");

await fetch(API,{
method:"POST",
body:JSON.stringify({
trajet,
voiture,
conducteur,
places,
passager:nom,
telephone:tel
})
});
}

async function remove(row){

await fetch(API,{
method:"POST",
body:JSON.stringify({action:"delete",row})
});
}

</script>

</body>
</html>
